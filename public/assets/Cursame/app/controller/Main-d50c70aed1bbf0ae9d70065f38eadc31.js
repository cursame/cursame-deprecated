Ext.define("Cursame.controller.Main",{extend:"Ext.app.Controller",config:{refs:{main:{selector:"mainview"},notificationsList:"notificationslist",notificationNavigationView:"notificationnavigationview",courseContainer:"coursecontainer",commentContainer:"commentcontainer",courseWall:"coursewall",commentWall:"commentwall",commentWallButton:"commentwall toolbar button",commentWallTextfield:"commentwall toolbar textfield",courseWallButton:"coursewall toolbar button",courseWallTextfield:"coursewall toolbar textfield",courseNavigationView:"coursenavigationview",courseList:"coursenavigationview courselist",courseMenu:"coursemenu",tabPanel:"tabpanel",surveyWall:"surveywall",assignmentWall:"assignmentwall",assignmentContainer:"assignmentcontainer",assignmentWallTextfield:"assignmentwall toolbar textfield",discussionWall:"discussionwall",discussionContainer:"discussioncontainer",discussionWallTextfield:"discussionwall toolbar textfield",userWall:"usernavigationview userwall",userNavigationView:"usernavigationview"},control:{"notificationslist notificationlistitem button":{tap:"onNotificationButtonTap"},notificationslist:{itemtap:"onNotificationTap"},coursewall:{itemtap:"onCourseWallTap"},"commentwall commentbar button":{tap:"onCommentWallPost"},"coursewall commentbar button":{tap:"onCourseWallPost"},"commentwall commentbar textfield":{change:"onCommentWallTextfieldChange"},"coursewall commentbar textfield":{change:"onCourseWallTextfieldChange"},coursenavigationview:{activate:"onCourseListPaint"},"coursenavigationview courselist":{itemtap:"onCourseTap"},"coursenavigationview coursemenu button":{tap:"onCourseMenuTap"},tabpanel:{activeitemchange:"onTabPanelChange"},"commentbar textfield":{change:"onCommentFieldChange"},"coursenavigationview userslist":{itemtap:"onUsersListTap"},"coursenavigationview assignmentslist":{itemtap:"onAssignmentsListTap"},"assignmentwall commentbar button":{tap:"onAssignmentWallPost"},assignmentwall:{itemtap:"onAssignmentWallTap"},"coursenavigationview surveyslist":{itemtap:"onSurveysListTap"},"coursenavigationview surveywall":{},"coursenavigationview discussionslist":{itemtap:"onDiscussionsListTap"},"discussionwall commentbar button":{tap:"onDiscussionWallPost"},discussionwall:{itemtap:"onDiscussionWallTap"}}},launch:function(){},onLogin:function(a){var b=Ext.getStore("Notifications");b.load()},onNotificationButtonTap:function(a,b){var c=a.getParent(),d=c.getRecord();this.maskComponent(this.getNotificationsList()),Cursame.ajax({url:"api/course_requests",scope:this,params:{id:d.data.notificator_id,accept:a.config.accept},success:function(a){Ext.getStore("Notifications").load({callback:this.onNotificationsStoreLoad,scope:this})}})},onNotificationsStoreLoad:function(){this.getNotificationsList().setMasked(!1)},onNotificationTap:function(a,b,c,d,e){if(!d.get("survey")){this.getNotificationNavigationView().push({xtype:"coursewall",title:d.data.courseObject.name}),this.loadStore(Ext.getStore("Comments"),{id:d.get("course_id"),type:"Course"},undefined);var f=d.get("courseObject"),g=d.get("courseOwner"),h=Ext.create("Cursame.model.Course",{id:f.id,name:f.name,description:f.description,image:f.logo_file,"public":f.public,start_date:f.start_date,finish_date:f.finish_date,owner:g.first_name+" "+g.last_name,members:d.get("courseMembers")});this.getCourseContainer().setRecord(h)}else alert("se trata de una tarea")},maskComponent:function(a){a.setMasked({xtype:"loadmask",message:lang.loading})},onCourseWallTap:function(a,b,c,d,e,f){e.getTarget("div.minibar")&&(this.getNotificationNavigationView().getItems().length===3?this.getNotificationNavigationView().push({xtype:"commentwall",title:lang.comments}):this.getCourseNavigationView().push({xtype:"commentwall",title:lang.comments}),this.loadStore(Ext.getStore("CommentsComments"),{id:d.get("id"),type:"Comment"},undefined),this.getCommentContainer().setRecord(d))},loadStore:function(a,b,c){a.load({callback:c,params:b,scope:this})},loadCommentsStore:function(a){},onCommentWallTextfieldChange:function(a,b,c,d){this.getCommentWallButton().setDisabled(b.replace(/ /g,"")=="")},onCourseWallTextfieldChange:function(a,b,c,d){this.getCourseWallButton().setDisabled(b.replace(/ /g,"")=="")},onCommentWallPost:function(a){var b=this.getCommentContainer().getRecord();this.saveComment("Comment",this.getCommentWallTextfield(),a,b.get("id"),Ext.getStore("CommentsComments"))},onCourseWallPost:function(a){var b=this.getCourseContainer().getRecord();this.saveComment("Course",this.getCourseWallTextfield(),a,b.get("id"),Ext.getStore("Comments"))},onAssignmentWallPost:function(a){var b=this.getAssignmentContainer().getRecord();this.saveComment("Assignment",this.getAssignmentWallTextfield(),a,b.get("id"),Ext.getStore("Comments"))},onDiscussionWallPost:function(a){var b=this.getDiscussionContainer().getRecord();this.saveComment("Discussion",this.getDiscussionWallTextfield(),a,b.get("id"),Ext.getStore("Comments"))},saveComment:function(a,b,c,d,e){c.disable(),Cursame.ajax({url:"api/create_comment",scope:this,params:{commentable_type:a,commentable_id:d,text:b.getValue()},success:function(c){this.loadStore(e,{id:d,type:a},function(){b.reset()})}})},onCourseListPaint:function(a){Ext.getStore("Courses").load()},onCourseTap:function(a,b,c,d,e,f){this.getCourseNavigationView().push({xtype:"coursemenu",title:d.get("name")}),this.getCourseMenu().items.items[0].setRecord(d)},onCourseMenuTap:function(a){var b=a.up("container").up("container"),c=b.items.items,d=c[0].getRecord();a.disable();switch(a.action){case"wall":this.getCourseNavigationView().push({xtype:"coursewall",title:d.get("name")}),this.loadStore(Ext.getStore("Comments"),{id:d.get("id"),type:"Course"},undefined),this.getCourseContainer().setRecord(d);break;case"members":this.getCourseNavigationView().push({xtype:"userslist",title:lang.members}),this.loadStore(Ext.getStore("Users"),{id:d.get("id"),type:"Course"},undefined);break;case"assignments":this.getCourseNavigationView().push({xtype:"assignmentslist",title:lang.assignments}),this.loadStore(Ext.getStore("Assignments"),{id:d.get("id")},undefined);break;case"surveys":this.getCourseNavigationView().push({xtype:"surveyslist",title:lang.surveys}),this.loadStore(Ext.getStore("Surveys"),{id:d.get("id")},undefined);break;case"discussions":this.getCourseNavigationView().push({xtype:"discussionslist",title:lang.discussions}),this.loadStore(Ext.getStore("Discussions"),{id:d.get("id")},undefined)}a.enable()},onTabPanelChange:function(a,b,c,d){var e=c.getItems().length;c.pop(e-1),b.type==="user"&&(this.getUserNavigationView().push({xtype:"userwall",title:Cursame.User.get("first_name")+" "+Cursame.User.get("last_name")}),this.loadStore(Ext.getStore("Users"),{type:"Profile"},undefined))},onUsersListTap:function(){},onAssignmentsListTap:function(a,b,c,d,e,f){this.getCourseNavigationView().push({xtype:"assignmentwall",title:d.get("name")}),this.loadStore(Ext.getStore("Comments"),{id:d.get("id"),type:"Assignment"},undefined),this.getAssignmentWall().items.items[0].setRecord(d)},onAssignmentWallTap:function(a,b,c,d,e,f){e.getTarget("div.minibar")&&(this.getCourseNavigationView().push({xtype:"commentwall",title:lang.comments}),this.loadStore(Ext.getStore("CommentsComments"),{id:d.get("id"),type:"Comment"},undefined),this.getCommentContainer().setRecord(d))},onSurveysListTap:function(a,b,c,d,e,f){this.getCourseNavigationView().push({xtype:"surveywall",title:d.get("name")}),this.loadStore(Ext.getStore("Comments"),{id:d.get("id"),type:"Survey"},undefined),this.getSurveyWall().items.items[0].setRecord(d)},onDiscussionsListTap:function(a,b,c,d,e,f){this.getCourseNavigationView().push({xtype:"discussionwall",title:d.get("name")}),this.loadStore(Ext.getStore("Comments"),{id:d.get("id"),type:"Discussion"},undefined),this.getDiscussionWall().items.items[0].setRecord(d)},onDiscussionWallTap:function(a,b,c,d,e,f){e.getTarget("div.minibar")&&(this.getCourseNavigationView().push({xtype:"commentwall",title:lang.comments}),this.loadStore(Ext.getStore("CommentsComments"),{id:d.get("id"),type:"Comment"},undefined),this.getCommentContainer().setRecord(d))},onCommentFieldChange:function(a,b,c,d){a.up("container").items.items[1].setDisabled(b.replace(/ /g,"")=="")}});
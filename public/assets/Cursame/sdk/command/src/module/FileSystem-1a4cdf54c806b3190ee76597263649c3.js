/**
 * @class Command.module.FileSystem
 * @author Jacky Nguyen <jacky@sencha.com>
 */
Ext.define("Command.module.FileSystem",{extend:"Command.module.Abstract",description:"A set of useful utility actions to work with files. Most commonly used actions are: concat, minify, delta",actions:{concat:["Concatenate multiple files into one",["from","f","List of files to concatenate, comma-separated","array",null,"foo.js,bar.js,baz.js"],["to","t","The destination file to write concatenated content","string",null,"target.js"]],minify:["Minify a JavaScript file, currently support YUICompressor (default), Closure Compiler and UglifyJS",["from","f","Path to the file to minify","string",null,"app.js"],["to","t","Path to the destination file to write minified content to.","string",null,"app-minified.js"],["compressor","c",'The name of the compressor to use, can be either: "yuicompressor", "uglifyjs" or "closurecompiler". Defaults to "yuicompressor"',"string","yuicompressor","uglifyjs"]],delta:["Generates deltas between two files in JSON format",["from","f","Path to the dictionary file","string",null,"version1.js"],["to","t","Path to the target file to compare to","string",null,"version2.js"],["delta","d","Path to a JSON file to write the delta content to","string",null,"delta.json"]]},concat:function(a,b,c){var d=require("fs"),e,f,g,h;c=c||"",h=d.openSync(b,"w");for(e=0,f=a.length;e<f;e++)g=a[e],d.writeSync(h,this.read(g)+c);d.closeSync(h)},minify:function(a,b,c,d){var e,f,g,h;d=d||Ext.emptyFn;if(c==="uglifyjs"){var i=require("uglify-js"),j=i.parser,k=i.uglify,l=j.parse(this.read(a));l=k.ast_mangle(l),l=k.ast_squeeze(l),h=k.gen_code(l),b?(this.write(b,h),d()):d(h)}else c==="closurecompiler"?(e="java -jar %s "+(b?"--js_output_file %s":"%s")+" --js %s",f=this.getVendorPath("closurecompiler/compiler.jar")):(e="java -jar %s "+(b?"-o %s":"%s")+" %s",f=this.getVendorPath("yuicompressor/yuicompressor.jar")),this.exec(e,[f,b,a],function(a,c,e){a?(this.error(a),this.error(e)):b?(c&&this.info(c),d()):d(c)})},delta:function(a,b,c,d){this.exec("%s encode -json -dictionary %s -target %s -delta %s --stats",[this.getVendorPath("vcdiff/"+this.cli.platformName+"/vcdiff"),a,b,c],function(a,b,e){if(a)this.error(e);else{b&&this.info(b);var f=this.read(c);this.write(c,f.substring(0,f.length-2)+"]"),d()}})},mkdir:function(){var a=require("fs"),b=require("path"),c=Array.prototype.slice.call(arguments),d=c.length,e,f,g,h,i,j;for(e=0;e<d;e++){h=c[e],j=[];while(!b.existsSync(h)){j.unshift(h),i=b.dirname(h);if(i===h)break;h=i}for(f=0,g=j.length;f<g;f++)h=j[f],a.mkdirSync(h)}},read:function(a){return require("fs").readFileSync(a,"utf8")},readJson:function(a){return Ext.JSON.decode(this.read(a))},write:function(a,b){var c=require("path");c.existsSync(a)||this.mkdir(c.dirname(a)),require("fs").writeFileSync(a,b,"utf8")},writeJson:function(a,b,c){return this.write(a,c?JSON.stringify(b,null,4):JSON.stringify(b))},prependFile:function(a,b){this.write(a,b+this.read(a))},appendFile:function(a,b){var c=require("fs"),d=c.openSync(a,"a");c.writeSync(d,b),c.closeSync(d)},copyFile:function(a,b){var c=require("fs"),d=require("path");d.existsSync(b)||this.mkdir(d.dirname(b)),c.writeFileSync(b,c.readFileSync(a)),c.chmodSync(b,c.statSync(a).mode.toString(8).substr(-3))},removeDirectory:function(a){var b=require("fs"),c=require("path"),d,e,f,g,h;d=b.readdirSync(a),h=d.length;if(h)for(g=0;g<h;g+=1)e=c.join(a,d[g]),f=b.statSync(e),f.isFile()?b.unlinkSync(e):f.isDirectory()&&this.removeDirectory(e);b.rmdirSync(a)},copyDirectory:function(a,b){var c=require("fs"),d=require("path"),e,f,g,h,i,j,k,l;this.mkdir(b),e=c.readdirSync(a);for(h=0,i=e.length;h<i;h++){f=e[h],k=d.join(a,f),l=d.join(b,f),g=c.lstatSync(k);if(g.isDirectory())this.copyDirectory(k,l);else if(g.isSymbolicLink())try{j=c.readlinkSync(k),c.symlinkSync(j,l)}catch(m){}else this.copyFile(k,l)}},checksum:function(a){var b=require("crypto").createHash("sha1");return b.update(this.read(a)),b.digest("hex")},copy:function(a,b){return require("fs").statSync(a).isDirectory()?this.copyDirectory(a,b):this.copyFile(a,b)}});
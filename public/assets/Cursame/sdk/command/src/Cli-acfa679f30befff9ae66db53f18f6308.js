/**
 * @class Command.Cli
 * @author Jacky Nguyen <jacky@sencha.com>
 */
Ext.define("Command.Cli",{config:{version:"",logger:null,currentPath:"",modules:{}},modules:{},templates:{},constructor:function(a){var b=process.platform;b==="win32"?b="win":b==="darwin"?b="osx":(b="linux",/64/.test(process.arch)&&(b+="64")),this.platformName=b,this.initConfig(a)},applyVersion:function(a){return new Ext.Version(a)},applyModules:function(a){var b=Ext.ClassManager,c,d;for(c in a)a.hasOwnProperty(c)&&(d=a[c],b.setAlias("Command.module."+d,"module."+c));return a},run:function(a){var b=this.parseArguments(a),c=b.targets,d=c.shift(),e=c.shift(),f;if(!d||!(f=this.getModule(d)))return this.printUsage();if(!e||!f.hasAction(e))return this.printUsage(d);try{this.execute(f,e,b)}catch(g){this.error(g.message),this.printUsage(d,e)}},getModule:function(a){var b=this.modules,c=b[a];if(!c){try{c=Ext.createByAlias("module."+a,this)}catch(d){return null}b[a]=c}return c},execute:function(a,b,c){var d=a.getActionRules(b).slice(1),e=[],f=c.targets,g,h,i,j,k,l,m,n,o;for(g=0,h=d.length;g<h;g++){i=d[g],l=i[0],m=i[1],n=i[3],o=i[4],k="--"+l;if(c.hasOwnProperty(l))j=this.formatArgumentValue(c[l],n,k);else if(m&&c.hasOwnProperty(m))k="-"+m,j=this.formatArgumentValue(c[m],n,k);else{j=f.shift();if(j!==undefined)j=this.formatArgumentValue(j,n,k);else{if(o===undefined||o===null)throw new Error("Missing required value for argument: '"+k+"'");j=o}}e.push(j)}a[b].apply(a,e)},formatArgumentValue:function(a,b,c){var d="Invalid value of: '"+a+"' for argument: '"+c+"', ";switch(b){case"number":if(isNaN(a))throw new Error(d+"must be a valid number");return Number(a);case"array":if(typeof a!="string")throw new Error(d+"must be a valid comma-separated list of items");return a.split(",");case"boolean":return a==="yes"?a=!0:a==="no"&&(a=!1),Boolean(a);default:return String(a)}},getTemplate:function(a){var b=this.templates,c=b[a],d;return c||(d=require("path").resolve(this.getCurrentPath(),"templates/"+a+".tpl"),b[a]=c=Ext.create("Ext.XTemplate",this.getModule("fs").read(d))),c},printUsage:function(a,b){var c=[],d=[],e,f;a?b?(e=this.getModule(a),f=e.actions[b],console.log(this.getTemplate("action").apply({module:a,name:b,description:f[0],args:f.slice(1)}))):(e=this.getModule(a),Ext.Object.each(e.actions,function(a,b){d.push({name:a,description:b[0],args:b.slice(1)})}),console.log(this.getTemplate("actions").apply({name:a,description:e.description,actions:d}))):(Ext.Object.each(this.getModules(),function(a){c.push({name:a,description:this.getModule(a).description})},this),console.log(this.getTemplate("modules").apply({version:this.getVersion().toString(),modules:c})))},parseArguments:function(a){var b=[],c={targets:b},d=null,e,f,g,h;for(e=0,f=a.length;e<f;e++){g=a[e];if(d!==null){if(!g.match(/^-{1,2}([^-])/i)){c[d]=g,d=null;continue}c[d]=!0,d=null}(h=g.match(/^--([^=]+)=(.*)$/i))?c[h[1]]=h[2]:(h=g.match(/^--(.+)$/i))||(h=g.match(/^-(.)$/i))?d=h[1]:(h=g.match(/^-(.+)$/i))?h[1].split("").forEach(function(a){c[a]=!0}):b.push(g)}return d!==null&&(c[d]=!0),c},doLog:function(a,b,c){return this.getLogger().log(a,b,c!==undefined?c:2)},log:function(a){return this.doLog(a,"verbose")},info:function(a){return this.doLog(a,"info")},warn:function(a){return this.doLog(a,"warn")},error:function(a){return this.doLog(a,"error")}});
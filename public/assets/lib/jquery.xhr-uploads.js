/*
 * jQuery XHR upload plugin
 * http://github.com/maca
 *
 * Copyright 2011, Macario Ortega
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 */
(function(a){a.fn.ajaxyUpload=function(b){var c={error:a.noop,success:a.noop,start:a.noop,complete:a.noop,spinner:{color:"#555",lines:6,length:2,width:9,radius:6}};return a(this).each(function(){var d=a(this);b&&a.extend(c,b),d.attr("multiple","multiple"),d.bind("xhrUpload",function(){var b=this;a.each(this.files,function(e,f){var g=a("<div>").addClass("inline-upload-advance"),h=a("<div>").addClass("inline-upload-progress-bar").append(g);(g.css("height").match(/\d/)[0]|0)==0&&g.css("height","10px"),g.css("background-color",g.css("background-color")||"#33a"),g.css("width","0px"),(h.css("width").match(/\d/)[0]|0)==0&&h.css("width","200px"),h.css("background-color",h.css("background-color")||"#fff"),h.css("border",h.css("border")||"1px solid #BBB"),d.after(h);var i=a.ajax({type:"POST",url:c.url,xhr:function(){var d=a.ajaxSettings.xhr();return d.upload.onprogress=function(a){var b=(a.loaded/a.total*100>>0)+"%";g.css("width",b)},d.onloadstart=function(){c.start.apply(b)},d},beforeSend:function(a){a.setRequestHeader("X-XHR-Upload","1"),a.setRequestHeader("X-File-Name",f.name||f.fileName),a.setRequestHeader("X-File-Size",f.fileSize)},success:function(a,d,e){c.success.apply(b,[a,d,e])},error:function(d,e,f){d.status==422?c.error.apply(b,[a.parseJSON(d.responseText)]):e!="abort"&&c.error.apply(b)},complete:function(a,e){d.after(d.clone(!1)).remove(),c.complete.apply(b),h.remove()},contentType:"application/octet-stream",dataType:"json",processData:!1,data:f});a(b).bind("cancelUpload",function(){return i.abort(),!0})})}),d.bind("iframeUpload",function(){var b=a("<input type='file' class='inline-upload-input'>").attr("name","file"),d=a("<iframe class='inline-upload-catcher'>").hide().attr("name","inline-upload-catcher-"+(new Date).getTime()),e=a("<div>").addClass("spinner"),f=a("<input type='hidden' name='authenticity_token'>").val(a("[name=csrf-token]").attr("content")),g=a("<form enctype='multipart/form-data' method='post'>").addClass("inline-upload-form").append(b).append(f);g.attr("target",d.attr("name")),(new Spinner(c.spinner)).spin(e[0]),(e.css("height").match(/\d/)[0]|0)==0&&e.css("height","20px"),(e.css("width").match(/\d/)[0]|0)==0&&e.css("width","20px"),a(this).after(g).after(d).hide(),b.bind("complete",function(b,d){d.errors?c.error.apply(this,[d]):c.success.apply(this,[d]),a(this).nextAll(".spinner").remove(),c.complete.apply(this)}),b.change(function(){c.start.apply(this),a(this).after(e),g.attr("action",c.url).submit()}),d.load(function(){b.trigger("complete",[a.parseJSON(a(this).contents().text())])})});var e=a.ajaxSettings.xhr();this.files&&e&&e.upload&&e.upload.onprogress!==undefined&&window.FileReader?d.change(function(){a(this).trigger("xhrUpload")}):d.trigger("iframeUpload")})}})(jQuery),function(a,b,c){function d(a){var b={x:a.offsetLeft,y:a.offsetTop};while(a=a.offsetParent)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}function e(a,b){for(var d in b)a[d]===c&&(a[d]=b[d]);return a}function f(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function g(a,b){var d=a.style,e,f;if(d[b]!==c)return b;b=b.charAt(0).toUpperCase()+b.slice(1);for(f=0;f<k.length;f++){e=k[f]+b;if(d[e]!==c)return e}}function h(a,b,c,d){var e=["opacity",b,~~(a*100),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=m.substring(0,m.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(n.insertRule("@"+i+"keyframes "+e+"{"+"0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+g+"}"+"}",0),l[e]=1),e}function i(a,b,c){return c&&!c.parentNode&&i(a,c),a.insertBefore(b,c||null),a}function j(a,c){var d=b.createElement(a||"div"),e;for(e in c)d[e]=c[e];return d}var k=["webkit","Moz","ms","O"],l={},m;i(b.getElementsByTagName("head")[0],j("style"));var n=b.styleSheets[b.styleSheets.length-1],o=function q(a){if(!this.spin)return new q(a);this.opts=e(a||{},{lines:12,length:7,width:5,radius:10,color:"#000",speed:1,trail:100,opacity:.25,fps:20})},p=o.prototype={spin:function(a){this.stop();var b=this,c=b.el=f(j(),{position:"relative"}),e,g;a&&(g=d(i(a,c,a.firstChild)),e=d(c),f(c,{left:(a.offsetWidth>>1)-e.x+g.x+"px",top:(a.offsetHeight>>1)-e.y+g.y+"px"})),c.setAttribute("aria-role","progressbar"),b.lines(c,b.opts);if(!m){var h=b.opts,k=0,l=h.fps,n=l/h.speed,o=(1-h.opacity)/(n*h.trail/100),p=n/h.lines;(function q(){k++;for(var a=h.lines;a;a--){var d=Math.max(1-(k+a*p)%n*o,h.opacity);b.opacity(c,h.lines-a,d,h)}b.timeout=b.el&&setTimeout(q,~~(1e3/l))})()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this}};p.lines=function(a,b){function c(a,c){return f(j(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*d)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}var d=0,e;for(;d<b.lines;d++)e=f(j(),{position:"absolute",top:1+~(b.width/2)+"px",transform:"translate3d(0,0,0)",opacity:b.opacity,animation:m&&h(b.opacity,b.trail,d,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&i(e,f(c("#000","0 0 4px #000"),{top:"2px"})),i(a,i(e,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},p.opacity=function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)},function(){var a=f(j("group"),{behavior:"url(#default#VML)"}),b;if(!g(a,"transform")&&a.adj){for(b=4;b--;)n.addRule(["group","roundrect","fill","stroke"][b],"behavior:url(#default#VML)");p.lines=function(a,b){function c(a,c,g){i(h,i(f(d(),{rotation:360/b.lines*a+"deg",left:~~c}),i(f(j("roundrect",{arcsize:1}),{width:e,height:b.width,left:b.radius,top:-b.width>>1,filter:g}),j("fill",{color:b.color,opacity:b.opacity}),j("stroke",{opacity:0}))))}function d(){return f(j("group",{coordsize:g+" "+g,coordorigin:-e+" "+ -e}),{width:g,height:g})}var e=b.length+b.width,g=2*e,h=d(),k=~(b.length+b.radius+b.width)+"px",l;if(b.shadow)for(l=1;l<=b.lines;l++)c(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=b.lines;l++)c(l);return i(f(a,{margin:k+" 0 0 "+k,zoom:1}),h)},p.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}else m=g(a,"animation")}(),a.Spinner=o}(window,document);
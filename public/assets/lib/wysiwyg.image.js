/**
 * Controls: Image plugin
 *
 * Depends on jWYSIWYG
 */
(function(a){"use strict";if(undefined===a.wysiwyg)throw"wysiwyg.image.js depends on $.wysiwyg";a.wysiwyg.controls||(a.wysiwyg.controls={}),a.wysiwyg.controls.image={groupIndex:6,visible:!0,exec:function(){a.wysiwyg.controls.image.init(this)},tags:["img"],tooltip:"Insert image",init:function(b){var c=this,d,e,f,g,h,i,j,k,l={alt:"",self:b.dom?b.dom.getElement("img"):null,src:"http://",title:""};i={legend:"Insert Image",preview:"Preview",url:"URL",title:"Title",description:"Description",width:"Width",height:"Height",original:"Original W x H","float":"Float",floatNone:"None",floatLeft:"Left",floatRight:"Right",submit:"Insert Image",reset:"Cancel",fileManagerIcon:"Select file from server"},g='<form class="wysiwyg" id="wysiwyg-addImage"><fieldset><div class="form-row"><span class="form-row-key">{preview}:</span><div class="form-row-value"><img src="" alt="{preview}" style="margin: 2px; padding:5px; max-width: 100%; overflow:hidden; max-height: 100px; border: 1px solid rgb(192, 192, 192);"/></div></div><div class="form-row"><label for="name">{url}:</label><div class="form-row-value"><input type="text" name="src" value=""/>',a.wysiwyg.fileManager&&a.wysiwyg.fileManager.ready&&(g+='<div class="wysiwyg-fileManager" title="{fileManagerIcon}"/>'),g+='</div></div><div class="form-row"><label for="name">{title}:</label><div class="form-row-value"><input type="text" name="imgtitle" value=""/></div></div><div class="form-row"><label for="name">{description}:</label><div class="form-row-value"><input type="text" name="description" value=""/></div></div><div class="form-row"><label for="name">{width} x {height}:</label><div class="form-row-value"><input type="text" name="width" value="" class="width-small"/> x <input type="text" name="height" value="" class="width-small"/></div></div><div class="form-row"><label for="name">{original}:</label><div class="form-row-value"><input type="text" name="naturalWidth" value="" class="width-small" disabled="disabled"/> x <input type="text" name="naturalHeight" value="" class="width-small" disabled="disabled"/></div></div><div class="form-row"><label for="name">{float}:</label><div class="form-row-value"><select name="float"><option value="">{floatNone}</option><option value="left">{floatLeft}</option><option value="right">{floatRight}</option></select></div></div><div class="form-row form-row-last"><label for="name"></label><div class="form-row-value"><input type="submit" class="button" value="{submit}"/> <input type="reset" value="{reset}"/></div></div></fieldset></form>';for(j in i)a.wysiwyg.i18n&&(k=a.wysiwyg.i18n.t(i[j],"dialogs.image"),k===i[j]&&(k=a.wysiwyg.i18n.t(i[j],"dialogs")),i[j]=k),h=new RegExp("{"+j+"}","g"),g=g.replace(h,i[j]);l.self&&(l.src=l.self.src?l.self.src:"",l.alt=l.self.alt?l.self.alt:"",l.title=l.self.title?l.self.title:"",l.width=l.self.width?l.self.width:"",l.height=l.self.height?l.self.height:"",l.styleFloat=a(l.self).css("float")),e=new a.wysiwyg.dialog(b,{title:i.legend,content:g}),a(e).bind("afterOpen",function(d,f){f.find("form#wysiwyg-addImage").submit(function(a){return a.preventDefault(),c.processInsert(f.container,b,l),e.close(),!1}),a.wysiwyg.fileManager&&a("div.wysiwyg-fileManager").bind("click",function(){a.wysiwyg.fileManager.init(function(a){f.find("input[name=src]").val(a),f.find("input[name=src]").trigger("change")})}),a("input:reset",f).click(function(a){return e.close(),!1}),a("fieldset",f).click(function(a){a.stopPropagation()}),c.makeForm(f,l)}),e.open(),a(b.editorDoc).trigger("editorRefresh.wysiwyg")},processInsert:function(b,c,d){var e,f=a('input[name="src"]',b).val(),g=a('input[name="imgtitle"]',b).val(),h=a('input[name="description"]',b).val(),i=a('input[name="width"]',b).val(),j=a('input[name="height"]',b).val(),k=a('select[name="float"]',b).val(),l=[],m="",n,o;c.options.controlImage&&c.options.controlImage.forceRelativeUrls&&(o=window.location.protocol+"//"+window.location.hostname,0===f.indexOf(o)&&(f=f.substr(o.length))),d.self?(a(d.self).attr("src",f).attr("title",g).attr("alt",h).css("float",k),i.toString().match(/^[0-9]+(px|%)?$/)?a(d.self).css("width",i):a(d.self).css("width",""),j.toString().match(/^[0-9]+(px|%)?$/)?a(d.self).css("height",j):a(d.self).css("height",""),c.saveContent()):(n=i.toString().match(/^[0-9]+(px|%)?$/),n&&(n[1]?l.push("width: "+i+";"):l.push("width: "+i+"px;")),n=j.toString().match(/^[0-9]+(px|%)?$/),n&&(n[1]?l.push("height: "+j+";"):l.push("height: "+j+"px;")),k.length>0&&l.push("float: "+k+";"),l.length>0&&(m=' style="'+l.join(" ")+'"'),e="<img src='"+f+"' title='"+g+"' alt='"+h+"'"+m+"/>",c.insertHtml(e))},makeForm:function(a,b){return a.find("input[name=src]").val(b.src),a.find("input[name=imgtitle]").val(b.title),a.find("input[name=description]").val(b.alt),a.find('input[name="width"]').val(b.width),a.find('input[name="height"]').val(b.height),a.find('select[name="float"]').val(b.styleFloat),a.find("img").attr("src",b.src),a.find("img").bind("load",function(){a.find("img").get(0).naturalWidth?(a.find('input[name="naturalWidth"]').val(a.find("img").get(0).naturalWidth),a.find('input[name="naturalHeight"]').val(a.find("img").get(0).naturalHeight)):a.find("img").attr("naturalWidth")&&(a.find('input[name="naturalWidth"]').val(a.find("img").attr("naturalWidth")),a.find('input[name="naturalHeight"]').val(a.find("img").attr("naturalHeight")))}),a.find("input[name=src]").bind("change",function(){a.find("img").attr("src",this.value)}),a}},a.wysiwyg.insertImage=function(b,c,d){return b.each(function(){var b=a(this).data("wysiwyg"),e,f;if(!b)return this;if(!c||c.length===0)return this;a.browser.msie&&b.ui.focus();if(d){b.editorDoc.execCommand("insertImage",!1,"#jwysiwyg#"),e=b.getElementByAttributeValue("img","src","#jwysiwyg#");if(e){e.src=c;for(f in d)d.hasOwnProperty(f)&&e.setAttribute(f,d[f])}}else b.editorDoc.execCommand("insertImage",!1,c);return b.saveContent(),a(b.editorDoc).trigger("editorRefresh.wysiwyg"),this})}})(jQuery);
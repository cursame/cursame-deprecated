<% if current_user.view_status == "fantom" %>
<%else%>
<%= semantic_form_for Comment.new, :remote => true, :url => polymorphic_path(commentable, :action => 'comment') do |form| %>
  <%= form.inputs :text do %>
    <%= form.input :text, :label => false, :input_html => {:rows => 3, :class => "textarea-size"}%>
  <% end %>
  
  <%= form.buttons do %>
    <%= render :partial => 'shared/assets_fields_for_comment', :locals => {:form => form} %>
  <% end %>
<% end %>
<%end%>
<script>
  $(function () {
  	var textAreaField = $('#comment_text'),
  		textAreaFieldValue, search = false,
  		setValueOnTextAreaField;

		notificationUsers = [];

  		setValueOnTextAreaField= function(event, ui){
  			var usuario = '<a href="/users/' + ui.item.id + '">' + ui.item.first_name +' '+ ui.item.last_name + '</a>',
  				comentario = textAreaFieldValue.split('@');
  				comentario[1]= usuario;			
  			textAreaField.val(comentario.join(' '));
  			search = false;

			// preparar para notificacione
			console.log('user_tag: { user_id: ' + ui.item.id + ', notificationUsers: ' + notificationUsers + ' }'); 
			notificationUsers.push(ui.item.id);

  			return false;
  		};

	textAreaField.autocomplete({
            source: "/search_users",
            minLength: 2,
            delay: 500,
            select: setValueOnTextAreaField,
            search:function (ev,obj) {
            	return search;
            },
        }).data("autocomplete")._renderItem = function (ul, item) {
            return $("<li></li>").data("item.autocomplete", item).append(
                '<a>'+ item.first_name +' '+ item.last_name + '</a>').appendTo(ul);
        };
    
    textAreaField.on('keyup',function(){
       	var name;
        textAreaFieldValue = textAreaField.val();
        name = textAreaFieldValue.split('@');
        console.log('keyup');
        if(name[1]){
            $("#comment_text").autocomplete( "search", name[1]);
            search = true;
        }
    });
 });
</script>
